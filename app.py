from flask import Flask, request, jsonify
import os
import telebot
from datetime import datetime

# üîë ÿ∂ÿπ ÿ™ŸàŸÉŸÜ ÿßŸÑÿ®Ÿàÿ™ ŸáŸÜÿß (ÿßÿ≠ÿµŸÑ ÿπŸÑŸäŸá ŸÖŸÜ @BotFather)
BOT_TOKEN = "8303404858:AAE2wAmDd17zZ7MDoQ-4Gu9DH3zqETaFaUk"
WEBHOOK_URL = f"https://tsar-7-4.onrender.com/{BOT_TOKEN}"

# ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®Ÿàÿ™ ŸàÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
bot = telebot.TeleBot(BOT_TOKEN)
app = Flask(__name__)

# üì± ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
@app.route("/")
def home():
    return """
    <!DOCTYPE html>
    <html lang="ar">
    <head>
        <meta charset="UTF-8">
            <title>‚úÖ ÿßŸÑÿ®Ÿàÿ™ ŸäÿπŸÖŸÑ</title>
                <style>
                        body {
                                    background: #000;
                                                color: #0f0;
                                                            text-align: center;
                                                                        padding: 100px;
                                                                                    font-family: Arial;
                                                                                            }
                                                                                                    .status { 
                                                                                                                background: #111;
                                                                                                                            padding: 20px;
                                                                                                                                        margin: 20px auto;
                                                                                                                                                    width: 80%;
                                                                                                                                                                border: 2px solid #0f0;
                                                                                                                                                                        }
                                                                                                                                                                                .btn {
                                                                                                                                                                                            background: #0f0;
                                                                                                                                                                                                        color: #000;
                                                                                                                                                                                                                    padding: 15px 30px;
                                                                                                                                                                                                                                text-decoration: none;
                                                                                                                                                                                                                                            font-weight: bold;
                                                                                                                                                                                                                                                        border-radius: 5px;
                                                                                                                                                                                                                                                                    display: inline-block;
                                                                                                                                                                                                                                                                                margin: 10px;
                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                            </style>
                                                                                                                                                                                                                                                                                            </head>
                                                                                                                                                                                                                                                                                            <body>
                                                                                                                                                                                                                                                                                                <h1>ü§ñ ÿ®Ÿàÿ™ ÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ ŸäÿπŸÖŸÑ</h1>
                                                                                                                                                                                                                                                                                                    <div class="status">
                                                                                                                                                                                                                                                                                                            <p>üü¢ <strong>ÿßŸÑÿ≠ÿßŸÑÿ©: ŸÜÿ¥ÿ∑</strong></p>
                                                                                                                                                                                                                                                                                                                    <p>üîó <strong>ÿßŸÑÿ±ÿßÿ®ÿ∑:</strong> https://tsar-7-3.onrender.com</p>
                                                                                                                                                                                                                                                                                                                            <p>üïê <strong>ÿßŸÑŸàŸÇÿ™:</strong> """ + datetime.now().strftime("%Y-%m-%d %H:%M:%S") + """</p>
                                                                                                                                                                                                                                                                                                                                    <p>ü§ñ <strong>ÿßŸÑÿ®Ÿàÿ™:</strong> Telegram Bot</p>
                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                            <a href="/setwebhook" class="btn">‚úÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®Ÿàÿ™ ÿßŸÑÿ¢ŸÜ</a>
                                                                                                                                                                                                                                                                                                                                                <a href="/test" class="btn">üì° ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ®Ÿàÿ™</a>
                                                                                                                                                                                                                                                                                                                                                    <p>ÿ®ÿπÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿå ÿ£ÿ±ÿ≥ŸÑ <code>/start</code> ŸÑŸÑÿ®Ÿàÿ™ ŸÅŸä ÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ</p>
                                                                                                                                                                                                                                                                                                                                                    </body>
                                                                                                                                                                                                                                                                                                                                                    </html>
                                                                                                                                                                                                                                                                                                                                                    """

                                                                                                                                                                                                                                                                                                                                                    # üîó ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®Ÿàÿ™
                                                                                                                                                                                                                                                                                                                                                    @app.route("/setwebhook", methods=["GET"])
                                                                                                                                                                                                                                                                                                                                                    def set_webhook():
                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                bot.remove_webhook()
                                                                                                                                                                                                                                                                                                                                                                        bot.set_webhook(url=WEBHOOK_URL)
                                                                                                                                                                                                                                                                                                                                                                                return f''"
                                                                                                                                                                                                                                                                                                                                                                                        <div style="background:green;color:white;padding:50px;text-align:center">
                                                                                                                                                                                                                                                                                                                                                                                                    <h1>‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®Ÿàÿ™!</h1>
                                                                                                                                                                                                                                                                                                                                                                                                                <p>ÿßŸÑÿ®Ÿàÿ™ ÿ¨ÿßŸáÿ≤ ŸÑÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ</p>
                                                                                                                                                                                                                                                                                                                                                                                                                            <p>üîó {WEBHOOK_URL}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                        <p><a href="/" style="color:yellow">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</a></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                        "'"
                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return f"<h1>‚ùå ÿÆÿ∑ÿ£: {str(e)}</h1>"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # üì® ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ®Ÿàÿ™
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route(f"/{BOT_TOKEN}", methods=["POST"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def webhook():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                json_data = request.get_json()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        update = telebot.types.Update.de_json(json_data)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                bot.process_new_updates([update])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return "ok", 200
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"ÿÆÿ∑ÿ£ ŸÅŸä webhook: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return "error", 500

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # üß™ ÿµŸÅÿ≠ÿ© ÿßÿÆÿ™ÿ®ÿßÿ±
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            @app.route("/test")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def test():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return jsonify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "status": "active",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "bot": "telegram",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "webhook": WEBHOOK_URL,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "time": datetime.now().isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    })

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # üéØ ÿ£ŸàÿßŸÖÿ± ÿßŸÑÿ®Ÿàÿ™
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @bot.message_handler(commands=["start"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def handle_start(message):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        bot.reply_to(message, f"üéâ ÿ£ŸáŸÑÿßŸã {message.from_user.first_name}!\n‚úÖ ÿßŸÑÿ®Ÿàÿ™ ŸäÿπŸÖŸÑ ÿπŸÑŸâ Render\nüîó ÿßŸÑŸÖŸàŸÇÿπ: https://tsar-7-3.onrender.com\nüìÖ ÿßŸÑŸàŸÇÿ™: {datetime.now().strftime("%H:%M:%S")}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @bot.message_handler(commands=["help"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def handle_help(message):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bot.reply_to(message, "üÜò ÿßŸÑÿ£ŸàÿßŸÖÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:\n/start - ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ\n/help - ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©\n/info - ŸÖÿπŸÑŸàŸÖÿßÿ™\n\nÿ£ÿ±ÿ≥ŸÑ ÿ£Ÿä ŸÜÿµ Ÿàÿ≥ÿ£ÿ±ÿØ ÿπŸÑŸäŸÉ!")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            @bot.message_handler(commands=["info"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def handle_info(message):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                bot.reply_to(message, f"üìä ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ®Ÿàÿ™:\nüë§ ÿßÿ≥ŸÖŸÉ: {message.from_user.first_name}\nüÜî ŸáŸàŸäÿ™ŸÉ: {message.from_user.id}\nü§ñ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ®Ÿàÿ™: ŸÜÿ¥ÿ∑\nüñ•Ô∏è ÿßŸÑÿÆÿßÿØŸÖ: Render")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                @bot.message_handler(func=lambda message: True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def echo_message(message):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    bot.reply_to(message, f"üì® ÿ™ŸÑŸÇŸäÿ™: {message.text}\n\nüë§ ŸÖŸÜ: {message.from_user.first_name}\nüÜî ID: {message.from_user.id}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ‚ö° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("="*50)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("üöÄ ÿ®ÿØÿ£ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ®Ÿàÿ™...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"üîó ŸàŸäÿ® ŸáŸàŸÉ: {WEBHOOK_URL}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®Ÿàÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    bot.remove_webhook()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bot.set_webhook(url=WEBHOOK_URL)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®Ÿàÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        port = int(os.environ.get("PORT", 10000))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.run(host="0.0.0.0', port=port, debug=False)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("="*50)